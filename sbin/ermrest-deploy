#!/bin/bash

# 
# Copyright 2012-2013 University of Southern California
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#    http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

if [[ $# -gt 0 ]]
then
    # allow VAR=value args to be passed on command-line
    exec /bin/env "$@" "$0"
fi

# paths set for installation
VARLIBDIR=/var/lib/ermrest
LIBEXECDIR=/usr/libexec/ermrest
SHAREDIR=/usr/share/ermrest
SBINDIR=/usr/sbin
HTTPDCONFDIR=${HTTPDCONFDIR:-/etc/httpd/conf.d}
SU=su

# named parameters that can be set by caller or on command-line above to override defaults...

DEPLOYLOCK="${DEPLOYLOCK}"          # deploy mutual-exclusion marker, if non-empty

PGADMIN="${PGADMIN:-postgres}"
DAEMONUSER1="${DAEMONUSER:-ermrestddl}" # Unix and DB user name for service daemon doing DDL
DAEMONUSER2="${DAEMONUSER:-ermrest}"    # Unix and DB user name for service daemon doing SQL

# make these available to child processes
export PGADMIN
export DAEMONUSER

id ${DAEMONUSER1} || useradd -m -r ${DAEMONUSER1}
id ${DAEMONUSER2} || useradd -m -r ${DAEMONUSER2}

chmod og+rx /home/${DAEMONUSER1}
chmod og+rx /home/${DAEMONUSER2}

pgid()
{
    line=$($SU -c "psql -q -t -A -c \"select * from pg_roles where rolname = '$1'\"" - "${PGADMIN}")
    status=$?
    [[ $status -eq 0 ]] || return $status
    [[ -n "$line" ]] || return 1
    echo "$line"
    return 0
}

pgcreateuser()
{
    $SU -c "createuser -d -R -S $1" - ${PGADMIN}
}

pgid ${DAEMONUSER1} || pgcreateuser ${DAEMONUSER1}
pgid ${DAEMONUSER2} || pgcreateuser ${DAEMONUSER2}
$SU -c "psql -c 'grant ermrest to ermrestddl'" - ${PGADMIN}

if [[ -r /etc/redhat-release ]]
then
    SEMANAGE_HTTPD_SYS_CONTENT_T=httpd_sys_content_t
    
    for daemon in ${DAEMONUSER1} ${DAEMONUSER2}
    do
	semanage fcontext --add --ftype d --type "${SEMANAGE_HTTPD_SYS_CONTENT_T}" "/home/${daemon}"
	semanage fcontext --add --type "${SEMANAGE_HTTPD_SYS_CONTENT_T}" "/home/${daemon}/ermrest_config.json"
	restorecon -v /home/${daemon}
	setsebool -P httpd_enable_homedirs on
    done
fi

[[ ! -r ${HTTPDCONFDIR}/wsgi_ermrest.conf ]] && cp ${SHAREDIR}/wsgi_ermrest.conf ${HTTPCONFDIR}/.

$SU -c "createdb -O \"$DAEMONUSER1\" ermrest" - ${PGADMIN}
$SU -c "psql -c 'GRANT ALL ON DATABASE ermrest TO ermrest'" - ${PGADMIN}
$SU -c "createlang -d ermrest plpgsql" - "${PGADMIN}"
$SU -c "psql -d template1 -c \"CREATE EXTENSION pg_trgm;\"" - ${PGADMIN}
$SU -c "cp -a ${SHAREDIR}/ermrest_config.json ." - "${DAEMONUSER2}"
$SU -c "ln -s /home/${DAEMONUSER2}/ermrest_config.json ." - "${DAEMONUSER1}"
$SU -c "${SBINDIR}/ermrest-registry-deploy" - "${DAEMONUSER1}"
$SU -c "${SBINDIR}/ermrest-webauthn2-deploy" - "${DAEMONUSER2}"

