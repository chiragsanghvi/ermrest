#!/bin/sh

# 
# Copyright 2012-2015 University of Southern California
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#    http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

DAEMONUSER="${DAEMONUSER:-ermrest}" # Unix and DB user name and DB name
DELETED="$1" # pass "--deleted" to flag lookup of deleted catalogs

# Drops the database using the PostgreSQL 'dropdb' utility.
#   - does not attempt to drain the database of connections first.
#   - tbd: add a '--force' flag to disconnect clients.
function drop_db {
    local _db=$1
    echo "DROPPING ${_db}"
    runuser -c "dropdb --if-exists --maintenance-db=${DAEMONUSER} \"${_db}\"" - "${DAEMONUSER}"
    return $?
}

# Deletes the catalog entry from the simple_registry.
function delete_catalog {
    local _id=$1
    echo "DELETING ${_id}"
    runuser -c "psql -q -c \"DELETE FROM ermrest.simple_registry WHERE id = '${_id}'\" ${DAEMONUSER}" - "${DAEMONUSER}"
    return $?
}

# for all deleted catalogs, attempt to dropdb and delete from registry
runuser -c "ermrest-registry-lookup ${DELETED} --key dbname" - "${DAEMONUSER}" | {
while read result
do
    id=$(echo "${result}" | awk '{ print $1 }')
    db=$(echo "${result}" | awk '{ print $2 }')

    drop_db "${db}"
    if [ $? -eq 0 ]; then
        delete_catalog "${id}"
        if [ $? -eq 0 ]; then
            echo "PURGED ${id} | ${db}"
        fi
    fi
done
}
